# frp实现内网穿透

## 准备一台公网服务器


## 下载frp
分别下载frp到公网服务器和内网服务器：
```shell
wget https://github.com/fatedier/frp/releases/download/v0.35.1/frp_0.35.1_linux_amd64.tar.gz
```

然后解压到`/usr/local`路径下
```shell
mkdir /usr/local/frp_0.35.1

tar -zxvf frp_0.35.1_linux_amd64.tar.gz -C /usr/local/frp_0.35.1 --strip-components 1
```

解压后路径`/usr/local/frp_0.35.1`内容如下
```shell
frpc  frpc_full.ini  frpc.ini  frps  frps_full.ini  frps.ini  LICENSE  systemd
```

*ps：`--strip-components 1 `表示跳过第一层目录进行解压*

## 配置公网服务器(frps:frp服务端)
修改 frps.ini 文件，这里使用了最简化的配置，设置了 frp 服务器用户接收客户端连接的端口：
```shell
vim /usr/local/frp_0.35.1/frps.ini

[common]
bind_port = 7000 # 这个是公网服务器的端口,我购买的是tecent云的服务器,其安全策略里面得设置开放此端口
```

## 配置内网服务器(frpc:frp客户端)
在需要被访问的内网机器上（SSH 服务通常监听在 22 端口）部署 frpc，修改 frpc.ini 文件，假设 frps 所在服务器的公网 IP 为 x.x.x.x：
```shell
vim /usr/local/frp_0.35.1/frpc.ini

[common]
server_addr = x.x.x.x
server_port = 7000 # 在公网开放的端口

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 600x # 这个是公网服务器的端口,安全策略里面也得设置开放此端口
```

由于笔者在内网有三台服务器需要通过同一台`frps(frp服务端)`，即同一台公网服务器做内网穿透，所以我这里三台服务器的`remote_port`分别配置为`6000`、`6001`、`6002`。

`local_ip `和` local_port `配置为本地需要暴露到公网的服务地址和端口。`remote_port `表示在` frp 服务端`监听的端口，访问此端口的流量将会被转发到本地服务对应的端口。

## 分别启动内网公网服务器FRP

### 1、在公网服务器上启动frps服务端
为了方便调试，我们先启动终端版：
```shell
cd frp_0.25.0_linux_amd64/
./frps -c ./frps.ini
nohup ./frps -c ./frps.ini &

# 链接成功会出现如下内容
# 2021/02/04 00:09:17 [I] [root.go:108] frps uses config file: ./frps.ini
# 2021/02/04 00:09:17 [I] [service.go:190] frps tcp listen on 0.0.0.0:7000
# 2021/02/04 00:09:17 [I] [root.go:217] frps started successfully
```

生产使用中可使用如下命令在后台运行：
```shell
nohup ./frps -c ./frps.ini > /dev/null 2>&1 &
```

### 2、在内网服务器中启动frpc客户端：
公网服务器启动成功后，在内网服务器中启动frpc,为了方便调试，我们一样启动终端版：
```shell
cd frp_0.25.0_linux_amd64/
./frpc -c ./frpc.ini
nohup ./frpc -c ./frpc.ini &

# 链接成功会出现如下内容
# 2021/02/04 00:11:47 [I] [service.go:290] [64276cca09e4f64c] login to server success, get run id [64276cca09e4f64c], server udp port [0]
# 2021/02/04 00:11:47 [I] [proxy_manager.go:144] [64276cca09e4f64c] proxy added: [ssh]
# 2021/02/04 00:11:48 [I] [control.go:180] [64276cca09e4f64c] [ssh] start proxy success
```
生产使用中可使用如下命令在后台运行：
```shell
nohup ./frpc -c ./frpc.ini > /dev/null 2>&1 &
```

## ssh登录服务器
如果配置成功，在进入本地服务器就相对容易了，与以前的ssh一样：
```shell
ssh root@公网IP -p 600x
```
也可以使用
```shell
ssh -oPort=600x root@公网IP
```

## 参考
[1]https://www.cnblogs.com/xlchan/p/13643231.html